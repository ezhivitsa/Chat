define("dataSource",[],function(){function n(e,t){var n=new XMLHttpRequest;n.open("get",e,!0),n.onreadystatechange=function(){if(n.readyState==4){var e=n.responseText?JSON.parse(n.responseText):{};t&&t(e,n.status)}},n.send()}function r(e,t,n){var r=new XMLHttpRequest,i=JSON.stringify(e);r.open("POST",t,!0),r.setRequestHeader("Content-type","application/json"),r.onreadystatechange=function(){if(r.readyState==4){var e=r.responseText?JSON.parse(r.responseText):{};n&&n(e,r.status)}},r.send(i)}var e="/",t={user:e+"user",userInfo:e+"user/id/$1/info",userLoaction:e+"user/geolocate",countNewPrivateMessages:e+"privateMessages/count",publicMessages:e+"publicMessages",message:e+"publicMessages/message",userUpdate:e+"user/update",dialogs:e+"dialogs/all",dialog:e+"dialogs/dialog/id/$1"};return{getUserName:function(e){n(t.user,e)},getUserNameById:function(e,r){var i=t.userInfo.replace("$1",e);n(i,r)},countNewPrivateMessages:function(e){n(t.countNewPrivateMessages,e)},getMessages:function(e,r,i){var s=t.publicMessages+"?";e&&(s+="time="+e+"&"),r&&(s+="limit="+r),n(s,i)},publishPublicMessage:function(e,n){r({message:e},t.message,n)},updateName:function(e,n){r({name:e},t.userUpdate,n)},getDialogs:function(e){n(t.dialogs,e)},getDialog:function(e,r,i,s){var o=t.dialog.replace("$1",e)+"?";r&&(o+="time="+r+"&"),i&&(o+="limit="+i),n(o,s)},publishPrivateMessage:function(e,n,i){var s=t.dialog.replace("$1",e);r({message:n},s,i)},publishLocation:function(e,n){r(e,t.userLoaction,n)}}}),define("helpers",[],function(){return{extend:function(e,t){e=e||{},t=t||{};var n={},r=null;for(r in t)n[r]=t[r];for(r in e)n[r]=e[r];return n}}}),define("elements/userName",["dataSource","helpers"],function(e,t){function n(e){this.defaults={parentSelector:"header",elementSelector:".name",inputSelector:"#name",buttonSelector:".change",errorSelector:".error"},this.init(e)}return n.prototype.init=function(e){this.opts=t.extend(e,this.defaults),this.opts.parent=document.querySelector(this.opts.parentSelector),this.opts.element=this.opts.parent.querySelector(this.opts.elementSelector),this.opts.input=document.querySelector(this.opts.inputSelector),this.opts.button=document.querySelector(this.opts.buttonSelector),this.opts.error=document.querySelector(this.opts.errorSelector)},n.prototype.appendName=function(){var t=this;e.getUserName(function(e,n){n==200&&(t.opts.element.innerHTML=e.name)})},n.prototype.listenChangeName=function(){var t=this;this.opts.button.addEventListener("click",function(){var n=t.opts.input.value;n&&e.updateName(n,function(e,n){switch(n){case 200:t.updateName(e.name),t.opts.input.value="",t.opts.error.style.display="none";break;case 403:t.opts.error.style.display="block",t.opts.error.innerHTML=e.message}})})},n.prototype.updateName=function(e){this.opts.element.innerHTML=e},n}),define("elements/privateMessages",["dataSource","helpers"],function(e,t){function n(){this.defaults={parentSelector:"header",linkSelector:".private-messages-count a",loadMoreSelector:".load-more",wrapperSelector:"section ul",textareaSelector:"#message",buttonSelector:"footer .send-message",interlocutorSelector:".interlocutor",limit:10,isEnd:!1,dateLastMessage:null,dateFirstMessage:new Date,commonDialogTemplate:'<li><core-item icon="account-circle"><div flex><a class="message-author" href="/private-messages.html/#$1" target="_self">$2</a><div class="number-of-messages">Number of messages: $3</div></div></core-item></li>',dialogTemplate:'<span class="message"><paper-shadow z="1">$2</paper-shadow></span>'},this.init()}return n.prototype.init=function(e){this.opts=t.extend(e,this.defaults),this.opts.parent=document.querySelector(this.opts.parentSelector),this.opts.link=document.querySelector(this.opts.linkSelector),this.opts.loadMore=document.querySelector(this.opts.loadMoreSelector),this.opts.wrapper=document.querySelector(this.opts.wrapperSelector),this.opts.textarea=document.querySelector(this.opts.textareaSelector),this.opts.button=document.querySelector(this.opts.buttonSelector),this.opts.interlocutor=document.querySelector(this.opts.interlocutorSelector)},n.prototype.appendCount=function(){var t=this;e.countNewPrivateMessages(function(e){t.opts.link.innerHTML=e.count||0})},n.prototype.appendAllDialogs=function(){var t=this;e.getDialogs(function(e,n){if(n==200){var r="";for(var i=0;i<e.dialogs.length;i++)r+=t.opts.commonDialogTemplate.replace("$1",e.dialogs[i].interlocutor._id).replace("$2",e.dialogs[i].interlocutor.name).replace("$3",e.dialogs[i].messages.all);t.opts.wrapper.innerHTML=r}})},n.prototype.loadOldMessages=function(t){var n=this,r=window.location.hash.substring(1);n.opts.isEnd||e.getDialog(r,this.opts.dateLastMessage,-this.opts.limit,function(e,r){if(r==200){var i=e.messages.length;if(t==="prepand")for(var s=0;s<i;s++)n._addMessageOnPage(e.messages[s],t);else for(var s=i-1;s>=0;s--)n._addMessageOnPage(e.messages[s],t);i&&(n.opts.dateLastMessage=e.messages[i-1].time),n.opts.isEnd=e.end,e.end&&(n.opts.loadMore.style.display="none")}})},n.prototype._addMessageOnPage=function(e,t){t=t||"append";var n=document.createElement("li");e.sender&&(n.className="my"),n.innerHTML=this.opts.dialogTemplate.replace("$2",e.message);if(t==="append")this.opts.wrapper.appendChild(n);else{var r=this.opts.wrapper.childNodes;r.length?this.opts.wrapper.insertBefore(n,r[0]):this.opts.wrapper.appendChild(n)}},n.prototype.appendDialogMessages=function(){var t=this,n=window.location.hash;e.getDialog(n,t.opts.dateLastMessage,t.opts.limit,function(e,t){t==200})},n.prototype.appendInterlocutorName=function(){var t=this,n=window.location.hash?window.location.hash.substring(1):"";e.getUserNameById(n,function(e,n){n==200&&(t.opts.interlocutor.innerHTML+=e.user.name)})},n.prototype.listenAddMessage=function(){var t=this,n=window.location.hash.substring(1);this.opts.button.addEventListener("click",function(){var r=t.opts.textarea.value;r&&e.publishPrivateMessage(n,r,function(e,n){n==201&&(t.opts.textarea.value="")})})},n.prototype.listenChat=function(){var t=this,n=window.location.hash.substring(1);e.getDialog(n,t.opts.dateFirstMessage,this.opts.limit,function(e,n){if(n==200){var r=e.messages.length;for(var i=r-1;i>=0;i--)t._addMessageOnPage(e.messages[i]);r&&(t.opts.dateLastMessage||(t.opts.dateLastMessage=e.messages[r-1].time),t.opts.dateFirstMessage=e.messages[0].time)}t.listenChat()})},n.prototype.listenLoadMessages=function(){var e=this;this.opts.loadMore.addEventListener("click",function(){e.loadOldMessages("prepand")})},n}),define("elements/header",["elements/userName","elements/privateMessages"],function(e,t){function n(){var n=new e,r=new t;n.appendName()}return n}),define("elements/publicMessages",["helpers","dataSource"],function(e,t){function n(){this.defaults={limit:10,isEnd:!1,dateLastMessage:null,dateFirstMessage:new Date,wrapperSelector:".messages ul",textareaSelector:"#message",buttonSelector:"footer .send-message",loadMoreSelector:".load-more",messageTemplate:'<core-item icon="input"><div flex><a class="message-author" href="/private-messages.html/#$1" target="_self">$2</a><div class="date">$3</div><div class="message-text">$4</div></div></core-item>'},this.init()}return n.prototype.init=function(t){this.opts=e.extend(t,this.defaults),this.opts.wrapper=document.querySelector(this.opts.wrapperSelector),this.opts.textarea=document.querySelector(this.opts.textareaSelector),this.opts.button=document.querySelector(this.opts.buttonSelector),this.opts.loadMore=document.querySelector(this.opts.loadMoreSelector)},n.prototype.getOldMessages=function(e){var n=this;n.opts.isEnd||t.getMessages(this.opts.dateLastMessage,-this.opts.limit,function(t,r){if(r==200){var i=t.messages.length;if(e==="prepand")for(var s=0;s<i;s++)n._addMessageOnPage(t.messages[s],e);else for(var s=i-1;s>=0;s--)n._addMessageOnPage(t.messages[s],e);i&&(n.opts.dateLastMessage=t.messages[i-1].time),n.opts.isEnd=t.end,t.end&&(n.opts.loadMore.style.display="none")}})},n.prototype.listenAddMessage=function(){var e=this;this.opts.button.addEventListener("click",function(){var n=e.opts.textarea.value;n&&t.publishPublicMessage(n,function(t,n){n==201&&(e.opts.textarea.value="")})})},n.prototype.listenLoadMessages=function(){var e=this;this.opts.loadMore.addEventListener("click",function(){e.getOldMessages("prepand")})},n.prototype._addMessageOnPage=function(e,t){t=t||"append";var n=document.createElement("li"),r=new Date(e.time),i=r.getDay()+"."+(r.getMonth()+1)+"."+r.getFullYear();n.innerHTML=this.opts.messageTemplate.replace("$1",e.author._id).replace("$2",e.author.name).replace("$3",i).replace("$4",e.message);if(t==="append")this.opts.wrapper.appendChild(n);else{var s=this.opts.wrapper.childNodes;s.length?this.opts.wrapper.insertBefore(n,s[0]):this.opts.wrapper.appendChild(n)}},n.prototype.listenChat=function(){var e=this;t.getMessages(e.opts.dateFirstMessage,this.opts.limit,function(t,n){if(n==200){var r=t.messages.length;for(var i=r-1;i>=0;i--)e._addMessageOnPage(t.messages[i]);r&&(e.opts.dateLastMessage||(e.opts.dateLastMessage=t.messages[r-1].time),e.opts.dateFirstMessage=t.messages[0].time)}e.listenChat()})},n}),define("pages/main",["elements/header","elements/publicMessages"],function(e,t){function n(){var n=new e,r=new t;r.getOldMessages(),r.listenAddMessage(),r.listenLoadMessages(),r.listenChat()}return n}),define("pages/privateMessages",["elements/header","elements/userName","elements/privateMessages"],function(e,t,n){function r(){var t=new e,r=new n;window.location.hash?(r.appendInterlocutorName(),r.loadOldMessages(),r.listenAddMessage(),r.listenChat(),r.listenLoadMessages()):(document.querySelector("body").classList.add("dialogs"),r.appendAllDialogs())}return r}),define("pages/user",["elements/header","elements/userName"],function(e,t){function n(){var n=new e,r=new t;r.listenChangeName()}return n}),define("pages/userLoactions",["dataSource","helpers"],function(e,t){function n(e){this.defaults={mapId:"users-map",mapOptions:{center:new google.maps.LatLng(44.5403,-78.5463),zoom:8,mapTypeId:google.maps.MapTypeId.ROADMAP}},this.init(e)}return n.prototype={constructor:n,init:function(e){this.opts=t.extend(e,this.defaults),this.userLocationsMap=document.getElementById(this.opts.mapId);var n=new google.maps.Map(this.userLocationsMap,this.opts.mapOptions)}},n}),define("elements/geolocation",["dataSource"],function(e){function t(){this.attempt=0,this.getLocation()}return t.prototype={constructor:t,getLocation:function(){var t=this;t.attempt++,navigator.geolocation.getCurrentPosition(function(n){t.attempt=0,e.publishLocation({lat:n.coords.latitude,"long":n.coords.longitude},function(){t.updateLocation.call(t)})},function(e){t.attempt<3?t.getLocation.call(t):(t.attempt=0,t.updateLocation.call(t))})},updateLocation:function(){var e=this;setTimeout(function(){e.getLocation.call(e)},18e5)}},t}),define("main",["pages/main","pages/privateMessages","pages/user","pages/userLoactions","elements/geolocation"],function(e,t,n,r,i){var s={main:e,"private-messages":t,user:n,locations:r},o=document.querySelector("body"),u=o.className,a=null;for(var f in s)if(u.indexOf(f)+1){a=s[f];break}if(!a)return;var f=new a,l=new i}),require.config({deps:["main"]}),define("config",function(){});